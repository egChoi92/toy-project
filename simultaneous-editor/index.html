<!DOCTYPE html>
<html lang='en'>
    <head>
        <meta charset='UTF-8' />
        <meta name='viewport' content='width=device-width, initial-scale=1.0' />
        <title>Collaborative Text Editor</title>
        <style>
            #content-wrapper {
                display: flex;
            }
            #editor {
                flex: 0.6;
                padding: 10px;
                border: 1px solid #ddd;
            }
            #sidebar {
                flex: 0.4;
                padding: 10px;
            }
        </style>
    </head>
    <body>
        <div id='editor-container'>
            <button id='join-button' onclick='showNicknameInput()'>
                방 만들기
            </button>
            <div id='nickname-layer' style='display: none'>
                <label for='nickname'>닉네임 설정</label>
                <input
                    type='text'
                    id='nickname'
                    placeholder='닉네임을 입력해주세요'
                />
                <button type='button' onclick='joinEditingRoom()'>입장</button>
            </div>
            <div id='content' style='display: none'>
                <div id='content-wrapper'>
                    <div id='editor' contenteditable='true'></div>
                    <div id='sidebar'>
                        <div id='sidebar-header'>참여자 목록</div>
                        <ul id='member-list'></ul>
                        <div id='notification'></div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            const nicknameLayerDiv = document.getElementById('nickname-layer');
            const nicknameInput = document.getElementById('nickname');
            const joinButton = document.getElementById('join-button');
            const contentDiv = document.getElementById('content');
            const editorDiv = document.getElementById('editor');
            const memberList = document.getElementById('member-list');
            const notificationDiv = document.getElementById('notification');
            const storageFunctionObject = {
                editor: () => getContentFromLocalStorage('editor')(updateEditor),
                member: () => getContentFromLocalStorage('member')(appendMember),
                notification: () => getContentFromLocalStorage('member')(showNotification),
            };

            let myNickname = null;
            let myId = 0

            const setContentFromLocalStorage = (id) => {
                const content = document.querySelector(`#${id}`).innerHTML;
                localStorage.setItem(id, content);
            }

            const getContentFromLocalStorage = (id) => {
                const localStorageData = localStorage.getItem(id);
                let parsedValue;
                try {
                    parsedValue = JSON.parse(localStorageData);
                } catch (error) {
                    parsedValue = localStorageData;
                }
                return function (callback) {
                    callback(parsedValue);
                };
            }

            const appendMember = (memberData) => {
                memberList.innerHTML = '';
                memberData.forEach((member) => {
                    const memberElement = document.createElement('li');
                    memberElement.textContent = member.nickname;
                    if (member.nickname === myNickname) {
                        memberElement.style.fontWeight = 'bold';
                    }
                    memberList.appendChild(memberElement);
                });
            }

            const updateEditor = (text) => {
                editorDiv.innerHTML = text;
            }

            const showNotification = (memberData) => {
                const memberLength = memberData.length - 1
                const newMember = memberData.find((member) => member.id === myId);
                if (newMember) {
                    notificationDiv.innerHTML = `${memberData[memberLength].nickname}님이 입장하였습니다.`;
                    setTimeout(() => {
                        notificationDiv.innerHTML = ''
                    }, 3000)
                }
            }

            const showNicknameInput = () => {
                nicknameLayerDiv.style.display = 'block';
                joinButton.style.display = 'none';
            }

            const joinEditingRoom = () => {
                const savedMember = JSON.parse(localStorage.getItem('member')) || [];
                const nickname = nicknameInput.value.trim();
                if (!nickname) return;

                const isSameNickname = savedMember.find(member => member.nickname === nickname)
                if (isSameNickname) return alert('같은 닉네임이 있습니다.')

                nicknameLayerDiv.style.display = 'none';
                contentDiv.style.display = 'block';

                myNickname = nickname;
                myId = savedMember.length;

                savedMember.push({ id: myId, nickname, cursorPosition: 0 });
                localStorage.setItem('member', JSON.stringify(savedMember));
                localStorage.setItem('notification', nickname);

                appendMember(savedMember);
                storageFunctionObject['editor']();
            }

            const getCaretPosition = () => {
                const sel = window.getSelection();
                if (sel.rangeCount === 0) return 0;
                const range = sel.getRangeAt(0);
                const preCaretRange = range.cloneRange();
                preCaretRange.selectNodeContents(editor);
                preCaretRange.setEnd(range.endContainer, range.endOffset);
                
                return preCaretRange.toString().length;
            }

            editorDiv.addEventListener('keyup', () => {
                const caretPosition = getCaretPosition();
                setContentFromLocalStorage('editor');
            });

            window.addEventListener('storage', function (event) {
                if (event.key) storageFunctionObject[event.key]();
            });

        </script>
    </body>
</html>
