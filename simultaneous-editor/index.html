<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collaborative Text Editor</title>
    <style>
        #content-wrapper {
            display: flex;
        }
        #editor {
            flex: 0.6;
            padding: 10px;
            border: 1px solid #ddd;
        }
        #sidebar {
            flex: 0.4;
            padding: 10px;
        }
    </style>
</head>
<body>
    <div id="editor-container">
        <button id="join-button" onclick="showNicknameInput()">방 만들기</button>
        <div id="nickname-layer" style="display: none;">
            <label for="nickname">닉네임 설정</label>
            <input type="text" id="nickname" placeholder="닉네임을 입력해주세요">
            <button tpye="button" onclick="joinEditingRoom()">입장</button>
        </div>
        <div id="content" style="display: none;">
            <div id="content-wrapper">
                <div id="editor" contenteditable="true"></div>
                <div id="sidebar">
                    <div id="sidebar-header">참여자 목록</div>
                    <ul id="member-list"></ul>
                    <div id="notification"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const nicknameLayerDiv = document.getElementById('nickname-layer');
        const nicknameInput = document.getElementById('nickname');
        const joinButton = document.getElementById('join-button');
        const contentDiv = document.getElementById('content');
        const editorDiv = document.getElementById('editor');
        const memberList = document.getElementById('member-list');
        const notificationDiv = document.getElementById('notification');
        let myNickname = null;        
        
        function showNicknameInput() {
            nicknameLayerDiv.style.display = 'block';
            joinButton.style.display = 'none';
        }

        function joinEditingRoom() {
            const nickname = nicknameInput.value.trim();
            if (!nickname) return;

            nicknameLayerDiv.style.display = 'none';
            contentDiv.style.display = 'block';

            myNickname = nickname;

            const savedMember = JSON.parse(localStorage.getItem('member')) || [];
            savedMember.push({ nickname, cursorPosition: 0 });
            localStorage.setItem('member', JSON.stringify(savedMember));

            appendMember(savedMember)

            for (const key in storageFunctionObject) {
                const storageFunction = storageFunctionObject[key]
                storageFunction();   
            }

        }

        function setContentFromLocalStorage(id) {
            const content = document.querySelector(`#${id}`).innerHTML;
            localStorage.setItem(id, content);
        }

        function getContentFromLocalStorage(id) {
            const localStorageData = localStorage.getItem(id);
            if (localStorageData !== null) {
                let parsedValue;
                try {
                    parsedValue = JSON.parse(localStorageData);
                } catch (error) {
                    parsedValue = localStorageData;
                }
                return function(callback) {
                    callback(parsedValue);
                }
            }
        }


        function appendMember(memberData) {
            memberList.innerHTML = '';
            memberData.forEach(member => {
                const memberElement = document.createElement('li');
                memberElement.textContent = member.nickname;
                if (member.nickname === myNickname) {
                    memberElement.style.fontWeight = 'bold';
                }
                memberList.appendChild(memberElement);
            });
        }

        function updateEditor(text) {
            console.log('editorDiv: ', editorDiv);
            editorDiv.innerHTML = text
        }


        function showNotification(memberData) {
            memberData.forEach(member => {
                if (member.nickname !== myNickname) {
                    notificationDiv.innerHTML = `${member.nickname}님이 입장하였습니다.`;
                }
            });
        }

        
        const storageFunctionObject = { 
            editor: () => getContentFromLocalStorage('editor')(updateEditor), 
            member: () => getContentFromLocalStorage('member')(appendMember), 
            notification: () => getContentFromLocalStorage('member')(showNotification) 
        }

        function getCaretPosition() {
            const sel = window.getSelection();
            if (sel.rangeCount === 0) return 0;
            const range = sel.getRangeAt(0);
            const preCaretRange = range.cloneRange();
            preCaretRange.selectNodeContents(editor);
            preCaretRange.setEnd(range.endContainer, range.endOffset);
            return preCaretRange.toString().length;
        }


        editorDiv.addEventListener('keyup', () => {
            const caretPosition = getCaretPosition();
            setContentFromLocalStorage('editor')
        });

        window.addEventListener('storage', function(event) {
            const storageFunction = storageFunctionObject[event.key]
            storageFunction()
        });

    </script>
</body>
</html>
