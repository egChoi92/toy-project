<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Collaborative Text Editor</title>
        <style>
            body {
                font-size: 16px;
            }
            #content-wrapper {
                display: flex;
            }

            #editor-box {
                position: relative;
                flex: 0.6;
                padding: 10px;
                border: 1px solid #ddd;
            }
            #editor {
                height: 100%;
            }
            #cursor-wrapper {
                position: absolute;
                top: 12px;
                width: 100%;
                height: 100%;
                pointer-events: none;
            }
            #cursor-wrapper > i {
                position: absolute;
                padding: 0 2px;
                border-left: 1px solid #000;
                font-size: 10px;
                animation: cursor 1s linear infinite;
                white-space: nowrap;
                background: #ccc;
            }
            #sidebar {
                flex: 0.4;
                padding: 10px;
            }
            @keyframes cursor {
                100% {
                    border-color: transparent;
                }
            }
        </style>
    </head>
    <body>
        <div id="editor-container">
            <button id="join-button" onclick="handleRoomCreate()">
                방 만들기
            </button>
            <div id="nickname-layer" style="display: none">
                <label for="nickname">닉네임 설정</label>
                <input
                    type="text"
                    id="nickname"
                    placeholder="닉네임을 입력해주세요"
                />
                <button type="button" onclick="handleRoomJoin()">입장</button>
            </div>
            <div id="content" style="display: none">
                <div id="content-wrapper">
                    <div id="editor-box">
                        <textarea id="editor" contenteditable="true"></textarea>
                        <div id="cursor-wrapper"></div>
                    </div>
                    <div id="sidebar">
                        <div id="sidebar-header">참여자 목록</div>
                        <ul id="member-list"></ul>
                        <div id="notification"></div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            const nicknameLayerDiv = document.getElementById("nickname-layer");
            const nicknameInput = document.getElementById("nickname");
            const joinButton = document.getElementById("join-button");
            const contentDiv = document.getElementById("content");
            const editorTextarea = document.getElementById("editor");
            const cursorWrapperDiv = document.getElementById("cursor-wrapper");
            const memberList = document.getElementById("member-list");
            const notificationDiv = document.getElementById("notification");
            const storageObject = {
                editor: () => handleAfterLocalStorage("editor")(updateEditor),
                member: () => handleAfterLocalStorage("member")(updateMember),
                newMember: () =>
                    handleAfterLocalStorage("newMember")(updateNotification),
                currentEditorialMember: () =>
                    handleAfterLocalStorage("currentEditorialMember")(updateCursor),
            };
            const initialCursorOffset = { x: 0, y: 0}

            let myNickname = null;
            let myId = 0;

            const updateEditor = (value) => {
                if (!value) return
                editorTextarea.value = value;
            };

            const updateMember = (memberData) => {
                memberList.innerHTML = "";
                cursorWrapperDiv.innerHTML = "";
                memberData.forEach((member) => {
                    const { id, nickname } = member;
                    const memberElement = document.createElement("li");
                    memberElement.textContent = nickname;
                    if (nickname === myNickname) {
                        memberElement.style.fontWeight = "bold";
                    }
                    memberList.appendChild(memberElement);
                    
                    const cursorElement = document.createElement("i");
                    cursorElement.textContent = nickname;
                    cursorElement.id = `cursor-${id}`;
                    if (id !== myId) cursorWrapperDiv.appendChild(cursorElement);
                });
            };

            const updateNotification = (newMemberData) => {
                notificationDiv.textContent = `${newMemberData.nickname}님이 입장하였습니다.`;
                setTimeout(() => {
                    notificationDiv.textContent = "";
                }, 3000);
            };
            
            function getByte(string) {
                
                const removeNewlineString = string.replaceAll('\n', '')
                
                return removeNewlineString
                    .split('')
                    .map(s => s.charCodeAt(0))
                    .reduce((prev, c) => (prev + ((c === 10) ? 2 : ((c >> 7) ? 2 : 1))), 0);
            }

            const updateCursor = (currentEditorialMemberData) => {
                const {id, cursorOffset, prevCursorOffset} = currentEditorialMemberData
                const cursorId = document.querySelector(`#cursor-${id}`)
                
                console.log('cursorOffset.y: ', cursorOffset.y);
                const x = cursorOffset.y - prevCursorOffset.y > 0 && cursorOffset.x > 0 
                    ? 0 
                    : cursorOffset.x

                cursorId.style.top = `${16 * (cursorOffset.y)}px`;
                cursorId.style.left = `${7.2 * x}px`;

            };

            const handleAfterLocalStorage = (storageKey) => {
                const localStorageData = localStorage.getItem(storageKey);
                let parsedValue;
                try {
                    parsedValue = JSON.parse(localStorageData);
                } catch (error) {
                    parsedValue = localStorageData;
                }
                return function (callback) {
                    callback(parsedValue);
                };
            };

            const handleRoomCreate = () => {
                nicknameLayerDiv.style.display = "block";
                joinButton.style.display = "none";
            };

            const handleRoomJoin = () => {
                const savedMemberData =
                    JSON.parse(localStorage.getItem("member")) || [];
                const nickname = nicknameInput.value.trim();
                if (!nickname) return;

                const isSameNickname = savedMemberData.find(
                    (member) => member.nickname === nickname
                );
                if (isSameNickname) return alert("같은 닉네임이 있습니다.");

                nicknameLayerDiv.style.display = "none";
                contentDiv.style.display = "block";

                myNickname = nickname;
                myId = savedMemberData.length;

                savedMemberData.push({ id: myId, nickname, prevCursorOffset: initialCursorOffset, cursorOffset: initialCursorOffset });
                localStorage.setItem("member", JSON.stringify(savedMemberData));
                localStorage.setItem("newMember", JSON.stringify({id: myId,nickname }));

                updateMember(savedMemberData);
                storageObject.editor();
            };

            const handleEditorUpdate = async (event) => {

                const savedCursorData = JSON.parse(localStorage.getItem("member"))
                const editorValue = editorTextarea.value;

                const selection = editorTextarea.selectionEnd;
                const newlineLength = editorValue.split('\n').length - 1;

                const cursorOffset = {
                    x: getByte(editorValue),
                    y: newlineLength,
                    // y: newlineLength > selection ? selection : newlineLength,
                }


                const currentEditorialMemberData = await(() => {
                    const savedCurrentEditorialMemberData = JSON.parse(localStorage.getItem("currentEditorialMember"));
                    const prevCursorOffset = savedCurrentEditorialMemberData 
                        ? savedCurrentEditorialMemberData.cursorOffset 
                        : initialCursorOffset;
                    return {
                        id: myId, 
                        nickname: myNickname, 
                        prevCursorOffset,
                        cursorOffset,
                    }
                })()

                console.log(currentEditorialMemberData);
                localStorage.setItem("currentEditorialMember", JSON.stringify(currentEditorialMemberData));

                if (event.type === 'keyup') localStorage.setItem("editor", editorValue);
            }

            // editorTextarea.addEventListener("input", function(event) {
            //     console.log('input');
            //     handleEditorUpdate(event)
            // });

            editorTextarea.addEventListener("keyup", function(event) {
                console.log('keyup');
                handleEditorUpdate(event)
            });

            window.addEventListener("storage", function (event) {
                if (event.key) storageObject[event.key]();
            });
        </script>
    </body>
</html>
